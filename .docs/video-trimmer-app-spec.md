# 웹 동영상 트리밍 앱 개발 명세

## 1. 프로젝트 개요
- **목적**: 브라우저에서 동영상을 업로드하고 트리밍하여 다운로드하는 웹 앱
- **원칙**: 서버 저장 없음, 모든 처리는 클라이언트 사이드에서 수행
- **성격**: 개인 프로젝트 (상업용 아님)

## 2. 기술 스택
| 기술 | 버전/비고 | 역할               |
|------|----|------------------|
| Next.js | 16 | 프레임워크 |
| Turbopack | -  | 번들러 |
| React | 19 | 라이브러리 |
| React Compiler | -  | 자동 메모이제이션 |
| TypeScript | -  | 타입 안정성           |
| FFmpeg.wasm | -  | 브라우저 내 동영상 트리밍   |
| Video.js | -  | 동영상 재생 (프리뷰 포함)  |
| wavesurfer.js | -  | 오디오 파형 시각화 (Phase 4) |
| Zustand | -  | 상태 관리 (단일 스토어)   |
| Tailwind CSS | -  | 스타일링             |
| Vitest | -  | 단위 테스트 (Phase 6) |
| Playwright | -  | E2E 테스트 (Phase 6) |

## 3. 기술 요구사항

### 3.1 COOP/COEP 헤더 설정 (필수)
FFmpeg.wasm의 SharedArrayBuffer 사용을 위해 `next.config.ts`에 설정:
```typescript
async headers() {
  return [{
    source: '/(.*)',
    headers: [
      { key: 'Cross-Origin-Opener-Policy', value: 'same-origin' },
      { key: 'Cross-Origin-Embedder-Policy', value: 'require-corp' },
    ],
  }];
}
```

### 3.2 FFmpeg.wasm 로딩 전략
- **로딩 시점**: 동영상 업로드 시작 시 (앱 진입 시 아님)
- **Progress 표시**: 파일 업로드와 별도로 FFmpeg 다운로드 Progress 표시
- **캐싱**: Service Worker 또는 HTTP Cache-Control로 캐싱
  - 새로고침/재방문 시 캐시에서 즉시 로드
- **편집 화면 진입 조건**: 파일 업로드 + FFmpeg 로딩 둘 다 완료 시

### 3.3 입력 사양
- **포맷**: FFmpeg.wasm 지원 포맷으로 한정
- **용량**: 최대 1GB
- **미준수 시**: 업로드 거절 + 경고 문구 표시

### 3.4 출력 사양
- 원본 메타데이터 유지 (화질, 해상도, 코덱 변경 없음)
- 파일명: `{원본파일명}_edited.{확장자}`

### 3.5 브라우저 호환성
- Chromium 기반 브라우저 (Chrome, Edge 등)

## 4. 용어 정의
| 용어 | 영문 | 설명 |
|------|------|------|
| 트리밍 | Trimming | 동영상 자르기 작업 |
| 인 포인트 | In Point | 트리밍 시작 지점 |
| 아웃 포인트 | Out Point | 트리밍 종료 지점 |
| 플레이헤드 | Playhead | 현재 재생 위치 |
| 타임라인 에디터 | Timeline Editor | 트리밍 제어 UI 컴포넌트 |

## 5. 화면 흐름
```
[업로드 화면]
     ↓ 파일 선택/드래그
[업로드 중] ← 2개 Progress 동시 표시
  ├─ 파일 업로드 Progress
  └─ FFmpeg.wasm 다운로드 Progress (캐시 시 즉시 완료)
     ↓ 둘 다 완료
[편집 화면] ← 비디오 플레이어 + 타임라인 에디터
     ↓ 완료 버튼
[처리 중] ← 트리밍 Progress (0~100%)
     ↓
[완료] → 다운로드 버튼
[실패] → 에러 메시지 표시
```

**추후 구현 (Phase 5):**
- 완료/실패 후 → 새 파일 편집, 재시도

## 6. 컴포넌트 구조

### 6.1 주요 컴포넌트 (별도 분리)
| 컴포넌트 | 역할 |
|----------|------|
| 레이아웃 | 전체 앱 레이아웃 |
| 업로드 | 파일 업로드 (드래그 앤 드롭), Progress 표시 |
| 비디오 플레이어 | Video.js 기반 재생 |
| 타임라인 에디터 | 트리밍 제어 UI |
| 다운로드 | 완료된 영상 다운로드 버튼 |
| 로딩 | 처리 중 Progress 표시 |
| 에러 | 에러 메시지 표시 (개발용) |

### 6.2 화면 전환
1. 초기: 업로드 컴포넌트만 표시
2. 업로드 시작: Progress 표시 (파일 + FFmpeg)
3. 완료: 타임라인 에디터 + 비디오 플레이어 표시
4. 완료 버튼 클릭: 트리밍 Progress 표시
5. 처리 완료: 다운로드 버튼 표시
6. 처리 실패: 에러 화면 표시

## 7. 타임라인 에디터 상세

### 7.1 UI 구성
- **형태**: 가로 막대형
- **배경**: 
  - Phase 2~3: 단색 배경
  - Phase 4: 오디오 파형 (wavesurfer.js), 오디오 없으면 빈 배경
- **양 끝**: 시작 시간(0) ~ 종료 시간(영상 길이) 표시

### 7.2 핸들 (3종류, UI상 명확히 구별)
| 핸들 | 초기 위치 | 조작 방법 |
|------|----------|----------|
| 인 포인트 | 0초 (영상 시작) | 드래그 또는 시간 입력 |
| 아웃 포인트 | 영상 끝 | 드래그 또는 시간 입력 |
| 플레이헤드 | 인 포인트 위치 | 클릭 또는 드래그 |

### 7.3 핸들 제약 조건
- 인 포인트는 아웃 포인트를 넘어설 수 없음
- 아웃 포인트는 인 포인트 이전으로 갈 수 없음
- 플레이헤드는 인 포인트 ~ 아웃 포인트 사이에서만 이동

### 7.4 잠금 기능 (Phase 4)
- 인 포인트, 아웃 포인트 시간 입력 옆에 자물쇠 UI
- 잠금 시 해당 핸들 이동 불가

### 7.5 재생 동작
- 재생 시작: 플레이헤드 위치 → 아웃 포인트까지
- 재생 종료 후 다시 재생: 플레이헤드 위치에서 시작
- 재생 중 플레이헤드 이동 시: 새 위치에서 재생 재시작

### 7.6 미리보기 옵션 (Phase 3~4)
- **(A) 전체 구간** (Phase 3): 인 포인트 ~ 아웃 포인트 재생
- **(B) 앞뒤 5초** (Phase 4): 
  - (인 포인트 ~ 인 포인트 +5초) + (아웃 포인트 -5초 ~ 아웃 포인트)
  - 구간이 10초 미만인 경우: 전체 구간 재생 (A와 동일)

### 7.7 줌 기능 (Phase 4)
- 조작: Ctrl + 마우스 휠

### 7.8 키보드 단축키
| 키 | 기능 | Phase |
|----|------|-------|
| Space | 재생/일시정지 | 2 |
| ← / → | 프레임 단위 이동 | 3 |
| Shift + ← / → | 1초 단위 이동 | 3 |
| I | 현재 플레이헤드 위치에 인 포인트 설정 | 3 |
| O | 현재 플레이헤드 위치에 아웃 포인트 설정 | 3 |
| Home | 인 포인트로 이동 | 3 |
| End | 아웃 포인트로 이동 | 3 |

## 8. Progress UI 정리
| 단계 | Progress 표시 | Phase |
|------|--------------|-------|
| FFmpeg.wasm 다운로드 | ✅ (업로드 시 동시) | 2 |
| 파일 업로드 | ✅ | 2 |
| 파형 생성 | ✅ | 4 |
| 트리밍 처리 | ✅ | 2 |

## 9. 에러 처리 (개발 단계)
- 에러 메시지 그대로 출력
- 개발자가 원인 파악 가능하도록 상세 표시

## 10. 폴더 구조 (Feature 기반)
```
src/
├── app/                    # Next.js App Router
├── features/
│   ├── upload/
│   │   ├── components/
│   │   ├── hooks/
│   │   └── utils/
│   ├── player/
│   │   ├── components/
│   │   └── hooks/
│   ├── timeline/
│   │   ├── components/
│   │   ├── hooks/
│   │   └── utils/
│   └── export/
│       ├── components/
│       └── utils/
├── stores/
│   └── useStore.ts         # 단일 Zustand 스토어
├── components/             # 공통 컴포넌트
├── hooks/                  # 공통 훅
├── utils/                  # 공통 유틸리티
├── constants/              # 상수
└── types/                  # 타입 정의
```

## 11. 설계 원칙
- 단일 기능 단일 책임 준수
- 컴포넌트, 유틸리티 함수, 상수 최대한 세분화
- 응집성 있는 구성
- 극단적 분리는 지양, 역할/기능 기준 분리

## 12. 개발 Phase

### Phase 1: 프로젝트 설정 및 기본 구동
- [ ] Next.js 16 + Turbopack + TypeScript 초기화
- [ ] Tailwind CSS 설정
- [ ] COOP/COEP 헤더 설정
- [ ] Zustand 스토어 구조 설정
- [ ] ESLint, Prettier 설정
- [ ] 폴더 구조 생성 (Feature 기반)
- [ ] 기본 레이아웃 컴포넌트
- [ ] 개발 서버 정상 구동 확인
- [ ] `tsc --noEmit` 통과 확인

### Phase 2: 핵심 흐름 + 기본 UI
- [ ] 파일 업로드 컴포넌트 (드래그 앤 드롭) + Progress
- [ ] 입력 사양 검증 (포맷, 1GB 제한) + 거절 시 경고
- [ ] FFmpeg.wasm 로딩 + Progress + 캐싱
- [ ] Video.js 플레이어 컴포넌트
- [ ] 타임라인 에디터 (단색 배경)
  - [ ] 인 포인트 / 아웃 포인트 핸들 (드래그)
  - [ ] 인 포인트 / 아웃 포인트 시간 입력
  - [ ] 플레이헤드 + 현재 시간 표시
  - [ ] 핸들 제약 조건 (인 < 아웃)
  - [ ] 핸들 UI 구별
- [ ] 재생 (Space)
- [ ] 트리밍 실행 + Progress
- [ ] 다운로드 (`_edited` suffix)
- [ ] 에러 표시 (원본 메시지 출력)

### Phase 3: 편의 기능
- [ ] 키보드 단축키 (←→, Shift+←→, I, O, Home, End)
- [ ] 미리보기 (A) 전체 구간

### Phase 4: 고급 기능
- [ ] wavesurfer.js 파형 표시 + Progress (오디오 없으면 빈 배경)
- [ ] 타임라인 줌 (Ctrl + 휠)
- [ ] 인/아웃 포인트 잠금 기능
- [ ] 미리보기 (B) 앞뒤 5초 옵션

### Phase 5: 흐름 완성
- [ ] 완료 후 새 파일 편집
- [ ] 실패 후 재시도

### Phase 6: 테스트
- [ ] Vitest 단위 테스트
  - [ ] 유틸리티 함수
  - [ ] Zustand 스토어
  - [ ] 핵심 로직
- [ ] Playwright E2E 테스트
  - [ ] 업로드 → 편집 → 트리밍 → 다운로드 전체 흐름
  - [ ] 에러 케이스
  - [ ] 키보드 단축키

## 13. 개발 완료 후 자가 진단 (필수)
각 Phase 완료 시:
1. **기능 테스트**: 해당 Phase 기능 정상 동작 확인
2. **타입 검사**: `tsc --noEmit` 실행하여 타입 에러 없음 확인
3. **린트 검사**: ESLint 에러 없음 확인
